<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-firestore.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <title>My Notifications</title>
</head>
<body>
    <button onclick="subscribe()">Subscribe</button>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyD97qANmG63Y_hxrWne13hzT4CYzDLntME",
            authDomain: "socialize-push.firebaseapp.com",
            databaseURL: "https://socialize-push.firebaseio.com",
            projectId: "socialize-push",
            storageBucket: "socialize-push.appspot.com",
            messagingSenderId: "386080765485",
            appId: "1:386080765485:web:63da65394f72b1a9fcaaa4"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const messaging = firebase.messaging();
        const firestore = firebase.firestore();

        getStartToken()
            .then(() => {
                messaging.onMessage(function(payload){
                    console.log("onMessage", payload);
                });
            })
            .catch(err => console.log(err));


        async function getStartToken(){
            try{
                const token = await messaging.getToken();
                if(token){
                    sendTokenToServer(token);
                }else {
                    await RequestPermission();
                    setTokenSentToServer(false);
                }
            }catch(error) {
                setTokenSentToServer(false);
                console.log(error);
            }
        }

        async function RequestPermission() {
            try {
                const permission = await messaging.requestPermission()
                if(permission ==='granted') {
                    console.log('permission granted');
                    await getStartToken();
                }else {
                    console.log('permission denied');                
                }
            }catch(error) {
                console.log(error);
            }
        }

        async function sendTokenToServer(token) {
            if(!isTokenSentToServer()) {
                const result = await firestore.collection('tokens').add({ token: token});
                console.log(result);
                setTokenSentToServer(true);
            }
            //     $.ajax({
            //         url: '',
            //         type: 'POST',
            //         data: {
            //             push_token: token
            //         },
            //         success: function(resposne) {
            //             setTokenSentToServer(true);
            //         },
            //         error: function(error) {
            //             setTokenSentToServer(false);
            //             console.log(error);
            //         }
            //     })
            // }
        }

        function isTokenSentToServer() {
            return window.localStorage.getItem('sendTokenToServer') === '1';
        }

        function setTokenSentToServer(sent) {
            window.localStorage.setItem('sendTokenToServer', sent ? '1' : '0');
        }
    </script>
    <script>
        // addEventListener('load', async () =>{
        //     let serviceWorker = await navigator.serviceWorker.register('service-worker.js');
        //     console.log(serviceWorker);
        // });

        async function subscribe(){
            let serviceWorker = await navigator.serviceWorker.ready;
            let push = await serviceWorker.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: 'BHL36786lRWEUvxLV0HrT5oqp7-nuSfPMGUTJBZNlUIWkOQfZo7pItZ05USM0uIDgif_LZGHFbG-7eyKl_SKIkI'
            });
            console.log(JSON.stringify(push));
        }
    </script>
</body>
</html>